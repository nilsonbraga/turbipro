generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  extensions        = [pgcrypto]
}

enum AppRole {
  super_admin
  admin
  agent
}

enum CollaboratorLevel {
  junior
  pleno
  senior
}

enum CommissionBase {
  sale_value
  profit
}

enum EmploymentType {
  clt
  pj
  freela
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique
  passwordHash String
  name         String?
  phone        String?
  avatarUrl    String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @db.Timestamptz(6)

  profile Profile?
  roles   UserRole[]

  proposalsCreated         Proposal[]               @relation("ProposalsCreatedBy")
  tasksCreated             Task[]                   @relation("TasksCreatedBy")
  studioTemplatesCreated   StudioTemplate[]         @relation("StudioTemplatesCreatedBy")
  financialTxCreated       FinancialTransaction[]   @relation("FinancialTransactionsCreatedBy")
  customItinerariesCreated CustomItinerary[]        @relation("CustomItineraryCreatedBy")
  proposalsHistory         ProposalHistory[]
  agencyEmails             AgencyEmail[]
  notificationPreferences  NotificationPreference[]
  taskAssignees            TaskAssignee[]
}

model Agency {
  id         String   @id @default(uuid()) @db.Uuid
  name       String
  cnpj       String?
  phone      String?
  email      String?
  address    String?
  logoUrl    String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @db.Timestamptz(6)

  profiles                Profile[]
  clients                 Client[]
  pipelineStages          PipelineStage[]
  proposals               Proposal[]
  partners                Partner[]
  tags                    Tag[]
  teams                   Team[]
  collaborators           Collaborator[]
  collaboratorGoals       CollaboratorGoal[]
  collaboratorCommissions CollaboratorCommission[]
  shiftTypes              ShiftType[]
  collaboratorSchedules   CollaboratorSchedule[]
  collaboratorTimeOff     CollaboratorTimeOff[]
  taskColumns             TaskColumn[]
  tasks                   Task[]
  expeditionGroups        ExpeditionGroup[]
  customItineraries       CustomItinerary[]
  financialTransactions   FinancialTransaction[]
  suppliers               Supplier[]
  agencySubscriptions     AgencySubscription[]
  studioTemplates         StudioTemplate[]
  agencyResendConfig      AgencyResendConfig?
  agencySmtpConfig        AgencySmtpConfig?
  agencyWhatsappConfig    AgencyWhatsappConfig?
  agencyEmailOauth        AgencyEmailOauth[]
  agencyEmails            AgencyEmail[]
  notificationPreferences NotificationPreference[]
  whatsappConversations   WhatsappConversation[]
  whatsappMessages        WhatsappMessage[]

  @@index([isActive])
}

model Profile {
  // Mantém o padrão: profile.id = user.id
  id        String   @id @db.Uuid
  agencyId  String?  @db.Uuid
  name      String?
  email     String?
  phone     String?
  avatarUrl String?
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  user   User    @relation(fields: [id], references: [id], onDelete: Cascade)
  agency Agency? @relation(fields: [agencyId], references: [id], onDelete: SetNull)

  @@index([agencyId])
  @@index([email])
}

model UserRole {
  id     String  @id @default(uuid()) @db.Uuid
  userId String  @db.Uuid
  role   AppRole @default(agent)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role]) // as migrations do Supabase já faziam isso
  @@index([role])
}

model Client {
  id        String    @id @default(uuid()) @db.Uuid
  agencyId  String    @db.Uuid
  name      String
  email     String?
  phone     String?
  cpf       String?
  passport  String?
  birthDate DateTime? @db.Date
  address   String?
  notes     String?
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @db.Timestamptz(6)

  agency                Agency                 @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  proposals             Proposal[]
  tasks                 Task[]
  itineraries           CustomItinerary[]
  financialTransactions FinancialTransaction[]

  @@index([agencyId])
  @@index([cpf])
  @@index([email])
}

model PipelineStage {
  id        String   @id @default(uuid()) @db.Uuid
  agencyId  String   @db.Uuid
  name      String
  color     String   @default("#3B82F6")
  order     Int      @default(0)
  isClosed  Boolean  @default(false)
  isLost    Boolean  @default(false)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  agency    Agency     @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  proposals Proposal[]

  @@unique([agencyId, order]) // facilita o seed de defaults por ordem
  @@index([agencyId])
}

model Proposal {
  id                     String  @id @default(uuid()) @db.Uuid
  agencyId               String  @db.Uuid
  clientId               String? @db.Uuid
  userId                 String? @db.Uuid
  assignedCollaboratorId String? @db.Uuid
  stageId                String? @db.Uuid

  number Int    @default(autoincrement())
  title  String
  status String @default("new")

  totalValue Decimal @default(0) @db.Decimal(12, 2)
  discount   Decimal @default(0) @db.Decimal(12, 2)

  commissionType  String  @default("percentage")
  commissionValue Decimal @default(0) @db.Decimal(12, 2)

  notes     String?
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  agency Agency  @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  client Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  createdBy User? @relation("ProposalsCreatedBy", fields: [userId], references: [id], onDelete: SetNull)

  assignedCollaborator Collaborator?  @relation("ProposalAssignedCollaborator", fields: [assignedCollaboratorId], references: [id], onDelete: SetNull)
  stage                PipelineStage? @relation(fields: [stageId], references: [id], onDelete: SetNull)

  services                ProposalService[]
  tags                    ProposalTag[]
  history                 ProposalHistory[]
  images                  ProposalImage[]
  tasks                   Task[]
  publicLinks             PublicProposalLink[]
  collaboratorCommissions CollaboratorCommission[]
  financialTransactions   FinancialTransaction[]

  @@unique([agencyId, number])
  @@index([agencyId])
  @@index([clientId])
  @@index([stageId])
  @@index([userId])
}

model ProposalService {
  id         String  @id @default(uuid()) @db.Uuid
  proposalId String  @db.Uuid
  partnerId  String? @db.Uuid

  type        String
  description String?
  origin      String?
  destination String?
  startDate   DateTime? @db.Timestamptz(6)
  endDate     DateTime? @db.Timestamptz(6)
  startTime   String?   @db.VarChar(10)
  endTime     String?   @db.VarChar(10)

  value Decimal @default(0) @db.Decimal(12, 2)
  cost  Decimal @default(0) @db.Decimal(12, 2)

  commissionType  String  @default("percentage")
  commissionValue Decimal @default(0) @db.Decimal(12, 2)

  details   Json     @default("{}")
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  proposal Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  partner  Partner? @relation(fields: [partnerId], references: [id], onDelete: SetNull)

  @@index([proposalId])
  @@index([partnerId])
}

model Partner {
  id             String   @id @default(uuid()) @db.Uuid
  agencyId       String   @db.Uuid
  name           String
  type           String?
  email          String?
  phone          String?
  commissionRate Decimal? @db.Decimal(12, 2)
  notes          String?
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @db.Timestamptz(6)

  agency   Agency            @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  services ProposalService[]

  @@index([agencyId])
  @@index([name])
}

model Tag {
  id        String   @id @default(uuid()) @db.Uuid
  agencyId  String   @db.Uuid
  name      String
  color     String   @default("#3B82F6")
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  agency    Agency        @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  proposals ProposalTag[]

  @@unique([agencyId, name])
  @@index([agencyId])
}

model ProposalTag {
  proposalId String @db.Uuid
  tagId      String @db.Uuid

  proposal Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([proposalId, tagId])
  @@index([tagId])
}

model Team {
  id          String   @id @default(uuid()) @db.Uuid
  agencyId    String   @db.Uuid
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  agency        Agency         @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  collaborators Collaborator[]

  @@unique([agencyId, name]) // usado pelo seed da function create_default_teams_and_collaborators
  @@index([agencyId])
}

model Collaborator {
  id       String  @id @default(uuid()) @db.Uuid
  agencyId String  @db.Uuid
  userId   String? @db.Uuid
  teamId   String? @db.Uuid

  name                 String
  email                String?
  phone                String?
  cpf                  String?
  status               String             @default("active")
  employmentType       EmploymentType     @default(clt)
  position             String?
  level                CollaboratorLevel?
  commissionPercentage Decimal            @default(0) @db.Decimal(12, 2)
  commissionBase       CommissionBase     @default(sale_value)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  agency Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  team   Team?  @relation(fields: [teamId], references: [id], onDelete: SetNull)

  proposalsAssigned Proposal[]               @relation("ProposalAssignedCollaborator")
  goals             CollaboratorGoal[]
  commissions       CollaboratorCommission[]
  schedules         CollaboratorSchedule[]
  timeOff           CollaboratorTimeOff[]

  @@unique([agencyId, userId])
  @@index([agencyId])
  @@index([teamId])
}

model CollaboratorGoal {
  id               String   @id @default(uuid()) @db.Uuid
  agencyId         String   @db.Uuid
  collaboratorId   String   @db.Uuid
  month            Int
  year             Int
  targetSalesValue Decimal  @default(0) @db.Decimal(12, 2)
  targetProfit     Decimal  @default(0) @db.Decimal(12, 2)
  targetDealsCount Int      @default(0)
  createdAt        DateTime @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @db.Timestamptz(6)

  agency       Agency       @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  collaborator Collaborator @relation(fields: [collaboratorId], references: [id], onDelete: Cascade)

  @@unique([collaboratorId, month, year])
  @@index([agencyId])
}

model CollaboratorCommission {
  id                   String         @id @default(uuid()) @db.Uuid
  agencyId             String         @db.Uuid
  collaboratorId       String         @db.Uuid
  proposalId           String         @db.Uuid
  periodMonth          Int
  periodYear           Int
  saleValue            Decimal        @default(0) @db.Decimal(12, 2)
  profitValue          Decimal        @default(0) @db.Decimal(12, 2)
  commissionPercentage Decimal        @default(0) @db.Decimal(12, 2)
  commissionBase       CommissionBase @default(sale_value)
  commissionAmount     Decimal        @default(0) @db.Decimal(12, 2)
  createdAt            DateTime       @default(now()) @db.Timestamptz(6)

  agency       Agency       @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  collaborator Collaborator @relation(fields: [collaboratorId], references: [id], onDelete: Cascade)
  proposal     Proposal     @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@unique([collaboratorId, proposalId, periodMonth, periodYear])
  @@index([agencyId])
}

model ShiftType {
  id        String   @id @default(uuid()) @db.Uuid
  agencyId  String   @db.Uuid
  name      String
  color     String?  @default("#3B82F6")
  startTime DateTime @db.Time(0)
  endTime   DateTime @db.Time(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  agency    Agency                 @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  schedules CollaboratorSchedule[]

  @@index([agencyId])
}

model CollaboratorSchedule {
  id             String    @id @default(uuid()) @db.Uuid
  agencyId       String    @db.Uuid
  collaboratorId String    @db.Uuid
  shiftTypeId    String?   @db.Uuid
  scheduleDate   DateTime  @db.Date
  startTime      DateTime? @db.Time(0)
  endTime        DateTime? @db.Time(0)
  notes          String?
  createdAt      DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @db.Timestamptz(6)

  agency       Agency       @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  collaborator Collaborator @relation(fields: [collaboratorId], references: [id], onDelete: Cascade)
  shiftType    ShiftType?   @relation(fields: [shiftTypeId], references: [id], onDelete: SetNull)

  @@unique([collaboratorId, scheduleDate])
  @@index([agencyId])
  @@index([collaboratorId])
}

model CollaboratorTimeOff {
  id             String   @id @default(uuid()) @db.Uuid
  agencyId       String   @db.Uuid
  collaboratorId String   @db.Uuid
  type           String
  startDate      DateTime @db.Date
  endDate        DateTime @db.Date
  reason         String?
  status         String   @default("approved")
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @db.Timestamptz(6)

  agency       Agency       @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  collaborator Collaborator @relation(fields: [collaboratorId], references: [id], onDelete: Cascade)

  @@index([agencyId])
  @@index([collaboratorId])
}

model TaskColumn {
  id        String   @id @default(uuid()) @db.Uuid
  agencyId  String   @db.Uuid
  name      String
  color     String   @default("#3B82F6")
  order     Int      @default(0)
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  agency Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  tasks  Task[]

  @@unique([agencyId, order])
  @@index([agencyId])
}

model Task {
  id          String    @id @default(uuid()) @db.Uuid
  agencyId    String    @db.Uuid
  columnId    String    @db.Uuid
  proposalId  String?   @db.Uuid
  clientId    String?   @db.Uuid
  createdById String    @db.Uuid
  title       String
  description String?
  dueDate     DateTime? @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(6)

  agency    Agency         @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  column    TaskColumn     @relation(fields: [columnId], references: [id], onDelete: Cascade)
  proposal  Proposal?      @relation(fields: [proposalId], references: [id], onDelete: SetNull)
  client    Client?        @relation(fields: [clientId], references: [id], onDelete: SetNull)
  createdBy User           @relation("TasksCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  assignees TaskAssignee[]

  @@index([agencyId])
  @@index([columnId])
  @@index([proposalId])
  @@index([clientId])
  @@index([createdById])
}

model TaskAssignee {
  id        String   @id @default(uuid()) @db.Uuid
  taskId    String   @db.Uuid
  userId    String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
}

model ExpeditionGroup {
  id                 String   @id @default(uuid()) @db.Uuid
  agencyId           String   @db.Uuid
  destination        String
  description        String?
  startDate          DateTime @db.Date
  durationDays       Int      @default(1)
  maxParticipants    Int      @default(10)
  priceCash          Decimal? @db.Decimal(12, 2)
  priceInstallment   Decimal? @db.Decimal(12, 2)
  installmentsCount  Int?
  currency           String   @default("BRL")
  coverImageUrl      String?
  carouselImages     String[]
  landingText        String?
  includedItems      String[]
  excludedItems      String[]
  testimonials       Json     @default("[]")
  faqs               Json     @default("[]")
  googleReviewsUrl   String?
  youtubeVideoUrl    String?
  showDatePreference Boolean  @default(false)
  isActive           Boolean  @default(true)
  publicToken        String   @default(dbgenerated("encode(gen_random_bytes(16), 'hex')"))
  createdAt          DateTime @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @db.Timestamptz(6)

  agency        Agency                   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  registrations ExpeditionRegistration[]

  @@unique([publicToken])
  @@index([agencyId])
  @@index([isActive])
}

model ExpeditionRegistration {
  id             String   @id @default(uuid()) @db.Uuid
  groupId        String   @db.Uuid
  name           String
  email          String
  phone          String?
  datePreference String?
  status         String   @default("confirmed")
  isWaitlist     Boolean  @default(false)
  createdAt      DateTime @default(now()) @db.Timestamptz(6)

  group ExpeditionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([email])
}

model CustomItinerary {
  id            String    @id @default(uuid()) @db.Uuid
  agencyId      String    @db.Uuid
  clientId      String?   @db.Uuid
  createdById   String?   @db.Uuid
  title         String
  description   String?
  destination   String?
  coverImageUrl String?
  startDate     DateTime? @db.Date
  endDate       DateTime? @db.Date
  status        String    @default("draft")
  isActive      Boolean   @default(true)
  requiresToken Boolean   @default(false)
  accessToken   String?
  publicToken   String    @default(dbgenerated("encode(gen_random_bytes(16), 'hex')"))
  approvedAt    DateTime? @db.Timestamptz(6)
  approvedBy    String?
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(6)

  agency    Agency  @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  client    Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)
  createdBy User?   @relation("CustomItineraryCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  days ItineraryDay[]

  @@unique([publicToken])
  @@index([agencyId])
  @@index([clientId])
}

model ItineraryDay {
  id            String    @id @default(uuid()) @db.Uuid
  itineraryId   String    @db.Uuid
  dayNumber     Int
  date          DateTime? @db.Date
  title         String?
  description   String?
  location      String?
  coverImageUrl String?
  images        String[]  @default([])
  sortOrder     Int       @default(0)
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(6)

  itinerary CustomItinerary        @relation(fields: [itineraryId], references: [id], onDelete: Cascade)
  items     ItineraryItem[]
  feedbacks ItineraryDayFeedback[]

  @@unique([itineraryId, dayNumber])
  @@index([itineraryId])
}

model ItineraryItem {
  id                 String    @id @default(uuid()) @db.Uuid
  dayId              String    @db.Uuid
  type               String
  title              String
  description        String?
  location           String?
  address            String?
  startTime          DateTime? @db.Time(0)
  endTime            DateTime? @db.Time(0)
  price              Decimal?  @db.Decimal(12, 2)
  currency           String    @default("BRL")
  confirmationNumber String?
  bookingReference   String?
  images             String[]
  details            Json      @default("{}")
  sortOrder          Int       @default(0)
  createdAt          DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @db.Timestamptz(6)

  day       ItineraryDay            @relation(fields: [dayId], references: [id], onDelete: Cascade)
  feedbacks ItineraryItemFeedback[]

  @@index([dayId])
}

model ItineraryDayFeedback {
  id          String   @id @default(uuid()) @db.Uuid
  dayId       String   @db.Uuid
  isApproved  Boolean?
  observation String?
  clientName  String?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  day ItineraryDay @relation(fields: [dayId], references: [id], onDelete: Cascade)

  @@index([dayId])
}

model ItineraryItemFeedback {
  id          String   @id @default(uuid()) @db.Uuid
  itemId      String   @db.Uuid
  isApproved  Boolean?
  observation String?
  clientName  String?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  item ItineraryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
}

model FinancialTransaction {
  id          String  @id @default(uuid()) @db.Uuid
  agencyId    String  @db.Uuid
  proposalId  String? @db.Uuid
  clientId    String? @db.Uuid
  supplierId  String? @db.Uuid
  createdById String? @db.Uuid

  type               String
  category           String?
  description        String
  totalValue         Decimal   @default(0) @db.Decimal(12, 2)
  profitValue        Decimal   @default(0) @db.Decimal(12, 2)
  installments       Int       @default(1)
  currentInstallment Int       @default(1)
  launchDate         DateTime  @default(dbgenerated("CURRENT_DATE")) @db.Date
  dueDate            DateTime? @db.Date
  paymentDate        DateTime? @db.Date
  paymentMethod      String?
  status             String    @default("pending")
  documentName       String?
  documentNumber     String?
  details            String?
  createdAt          DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @db.Timestamptz(6)

  agency    Agency    @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  proposal  Proposal? @relation(fields: [proposalId], references: [id], onDelete: SetNull)
  client    Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  supplier  Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  createdBy User?     @relation("FinancialTransactionsCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([agencyId])
  @@index([proposalId])
  @@index([clientId])
  @@index([supplierId])
  @@index([status])
}

model Supplier {
  id        String   @id @default(uuid()) @db.Uuid
  agencyId  String   @db.Uuid
  name      String
  type      String?
  cnpj      String?
  email     String?
  phone     String?
  address   String?
  notes     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  agency                Agency                 @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  financialTransactions FinancialTransaction[]

  @@index([agencyId])
  @@index([isActive])
}

model SubscriptionPlan {
  id                   String   @id @default(uuid()) @db.Uuid
  name                 String
  description          String?
  priceMonthly         Decimal? @db.Decimal(12, 2)
  priceYearly          Decimal? @db.Decimal(12, 2)
  maxUsers             Int?
  maxClients           Int?
  maxProposals         Int?
  modules              String[] @default([])
  stripePriceIdMonthly String?
  stripePriceIdYearly  String?
  trialDays            Int      @default(7)
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now()) @db.Timestamptz(6)

  subscriptions AgencySubscription[]

  @@index([isActive])
}

model AgencySubscription {
  id                   String    @id @default(uuid()) @db.Uuid
  agencyId             String    @db.Uuid
  planId               String?   @db.Uuid
  couponId             String?   @db.Uuid
  billingCycle         String    @default("monthly")
  status               String    @default("active")
  stripeCustomerId     String?
  stripeSubscriptionId String?
  currentPeriodStart   DateTime? @db.Timestamptz(6)
  currentPeriodEnd     DateTime? @db.Timestamptz(6)
  gracePeriodDays      Int       @default(7)
  discountApplied      Decimal   @default(0) @db.Decimal(12, 2)
  createdAt            DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt            DateTime  @updatedAt @db.Timestamptz(6)

  agency Agency            @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  plan   SubscriptionPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)
  coupon DiscountCoupon?   @relation(fields: [couponId], references: [id], onDelete: SetNull)

  @@unique([agencyId])
  @@index([status])
}

model DiscountCoupon {
  id              String    @id @default(uuid()) @db.Uuid
  code            String    @unique
  description     String?
  discountType    String    @default("percentage")
  discountValue   Decimal   @default(0) @db.Decimal(12, 2)
  maxUses         Int?
  currentUses     Int       @default(0)
  validFrom       DateTime? @db.Timestamptz(6)
  validUntil      DateTime? @db.Timestamptz(6)
  applicablePlans String[]  @default([]) // guarda UUIDs como string; simples e compatível
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @db.Timestamptz(6)

  subscriptions AgencySubscription[]

  @@index([isActive])
}

model PlatformSetting {
  id           String   @id @default(uuid()) @db.Uuid
  settingKey   String   @unique
  settingValue String?
  createdAt    DateTime @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @db.Timestamptz(6)
}

model StudioTemplate {
  id          String   @id @default(uuid()) @db.Uuid
  agencyId    String?  @db.Uuid
  createdById String?  @db.Uuid
  templateId  Int      @default(0)
  formatId    String   @default("custom")
  artTypeId   String   @default("custom")
  name        String
  data        Json     @default("{}")
  colors      Json     @default("{}")
  icons       Json?
  images      String[] @default([])
  logoUrl     String?
  blurLevel   Int      @default(24)
  isFavorite  Boolean  @default(false)
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  agency    Agency? @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  createdBy User?   @relation("StudioTemplatesCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([agencyId])
  @@index([createdById])
}

model PublicProposalLink {
  id         String    @id @default(uuid()) @db.Uuid
  proposalId String    @db.Uuid
  token      String    @default(dbgenerated("encode(gen_random_bytes(32), 'hex')"))
  isActive   Boolean   @default(true)
  expiresAt  DateTime? @db.Timestamptz(6)
  createdAt  DateTime  @default(now()) @db.Timestamptz(6)

  proposal Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([proposalId])
}

model ProposalHistory {
  id          String   @id @default(uuid()) @db.Uuid
  proposalId  String   @db.Uuid
  userId      String?  @db.Uuid
  action      String
  description String?
  oldValue    Json?
  newValue    Json?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)

  proposal Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([proposalId])
  @@index([userId])
}

model ProposalImage {
  id         String   @id @default(uuid()) @db.Uuid
  proposalId String   @db.Uuid
  url        String
  caption    String?
  createdAt  DateTime @default(now()) @db.Timestamptz(6)

  proposal Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@index([proposalId])
}

model AgencyResendConfig {
  id              String   @id @default(uuid()) @db.Uuid
  agencyId        String   @unique @db.Uuid
  apiKeyEncrypted String?
  fromEmail       String?
  fromName        String?
  isConfigured    Boolean  @default(false)
  createdAt       DateTime @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @db.Timestamptz(6)

  agency Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)
}

model AgencySmtpConfig {
  id                String   @id @default(uuid()) @db.Uuid
  agencyId          String   @unique @db.Uuid
  smtpHost          String?
  smtpPort          Int      @default(587)
  smtpUser          String?
  smtpPassEncrypted String?
  smtpFromEmail     String?
  smtpFromName      String?
  isConfigured      Boolean  @default(false)
  createdAt         DateTime @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @db.Timestamptz(6)

  agency Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)
}

model AgencyWhatsappConfig {
  id                 String   @id @default(uuid()) @db.Uuid
  agencyId           String   @unique @db.Uuid
  phoneNumberId      String?
  accessToken        String?
  businessAccountId  String?
  webhookVerifyToken String?
  isConfigured       Boolean  @default(false)
  createdAt          DateTime @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @db.Timestamptz(6)

  agency Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)
}

model AgencyEmailOauth {
  id             String    @id @default(uuid()) @db.Uuid
  agencyId       String    @db.Uuid
  provider       String
  accessToken    String?
  refreshToken   String?
  tokenExpiresAt DateTime? @db.Timestamptz(6)
  emailAddress   String?
  isConfigured   Boolean   @default(false)
  createdAt      DateTime  @default(now()) @db.Timestamptz(6)

  agency Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@index([agencyId])
  @@index([provider])
}

model AgencyEmail {
  id         String    @id @default(uuid()) @db.Uuid
  agencyId   String    @db.Uuid
  userId     String?   @db.Uuid
  provider   String    @default("smtp")
  messageId  String?
  threadId   String?
  fromEmail  String
  fromName   String?
  toEmails   String[]
  ccEmails   String[]  @default([])
  bccEmails  String[]  @default([])
  subject    String
  bodyText   String?
  bodyHtml   String?
  isRead     Boolean   @default(false)
  isStarred  Boolean   @default(false)
  isSent     Boolean   @default(false)
  folder     String    @default("inbox")
  sentAt     DateTime? @db.Timestamptz(6)
  receivedAt DateTime? @db.Timestamptz(6)
  createdAt  DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime  @updatedAt @db.Timestamptz(6)

  agency Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([agencyId])
  @@index([userId])
  @@index([folder])
  @@index([isRead])
}

model NotificationPreference {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @unique @db.Uuid
  agencyId         String?  @db.Uuid
  newLead          Boolean  @default(true)
  proposalClosed   Boolean  @default(true)
  followUpReminder Boolean  @default(true)
  weeklyReport     Boolean  @default(false)
  createdAt        DateTime @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @db.Timestamptz(6)

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  agency Agency? @relation(fields: [agencyId], references: [id], onDelete: SetNull)

  @@index([agencyId])
}

model WhatsappConversation {
  id            String    @id @default(uuid()) @db.Uuid
  agencyId      String    @db.Uuid
  waContactId   String
  contactName   String?
  contactPhone  String
  unreadCount   Int       @default(0)
  lastMessageAt DateTime? @db.Timestamptz(6)
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(6)

  agency   Agency            @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  messages WhatsappMessage[]

  @@index([agencyId])
  @@index([waContactId])
}

model WhatsappMessage {
  id             String   @id @default(uuid()) @db.Uuid
  conversationId String   @db.Uuid
  agencyId       String   @db.Uuid
  direction      String
  messageType    String   @default("text")
  content        String?
  status         String   @default("sent")
  sentAt         DateTime @db.Timestamptz(6)
  createdAt      DateTime @default(now()) @db.Timestamptz(6)

  conversation WhatsappConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  agency       Agency               @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([agencyId])
}
